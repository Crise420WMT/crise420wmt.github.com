<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title></title>
    <style>
        *{margin: 0;padding: 0;list-style: none;}
        #box{margin: 100px auto;width: 800px;}
        input{margin-right: 10px;}
        span strong{color: red;}
        #main{margin-top:20px;background-image:url("img/canvas.jpg");
            border: 1px solid #000000;position: relative;}
    </style>
    <script src="js/DOMReady.js"></script>
    <script>
        function rnd(n,m){
            return parseInt(Math.random()*(m-n))+n;
        }
        DOMReady(function(){
            var oStart=document.getElementById('open');
            var oScore=document.querySelector('.score');
            var oMain=document.getElementById('main');
            var snackBody=[{left:0,top:1,background:'pink',obj:null},{left:1,top:1,background:'pink',obj:null},{left:2,top:1,background:'red',obj:null}];
            var oAcc=document.getElementById('accelerate');
            var oPause=document.getElementById('pause');
            var reStart=document.getElementById('restart');

            var oW=800;
            var oH=400;
            var bTrue=false;
            var timer=null;
            var len=20;
            var dir='right';
            var arrFood=[];
            var food=null;
            var speed=200;
            var oX=Math.floor(oW/len);
            var oY=Math.floor(oH/len);

            oMain.style.width=oW+'px';
            oMain.style.height=oH+'px';
            createFood();
            createSnack();

            var iNow=0;
            oAcc.onclick=function(){
                speed-=20;
                iNow++;
                this.value='级别'+iNow;
                if(iNow>=6){
                    this.disabled=true;
                }
            };
            reStart.onclick=function(){
                var t=confirm('是否重置？');
                if(t){
                    window.location.reload();
                }
            };
            oStart.onclick=move;
            oPause.onclick=pause;

            function pause(){
                if(bTrue){
                    move();
                    oPause.value='暂停(space)';
                }else{
                    clearInterval(timer);
                    oPause.value='继续(space)';
                }
                bTrue=!bTrue;
            };
            function createFood(){
                arrFood=[rnd(0,oX),rnd(0,oY)];
                if(food==null){
                    food=document.createElement('div');

                    food.style.background='pink';
                    food.style.width=20+'px';
                    food.style.height=20+'px';
                    food.style.position='absolute';

                    oMain.appendChild(food);
                }
                food.style.left=arrFood[0]*20+'px';
                food.style.top=arrFood[1]*20+'px';
                //return arr;
            }
            function setPos(obj,n){
                obj.style.left=snackBody[n].left*len+'px';
                obj.style.top=snackBody[n].top*len+'px';
                obj.style.background=snackBody[n].background;
            }
            function createSnack(){
                for(var i=0;i<snackBody.length;i++){
                    //alert(1);
                    if(snackBody[i].obj==null){
                        //alert(1);
                        snackBody[i].obj=document.createElement('div');
                        //console.log(snackBody[i].obj);
                        snackBody[i].obj.style.position='absolute';
                        snackBody[i].obj.style.width=len+'px';
                        snackBody[i].obj.style.height=len+'px';
                        oMain.appendChild(snackBody[i].obj);

                    }
                    setPos(snackBody[i].obj,i);
                }
            }
            function move(){
                clearInterval(timer);
                timer=setInterval(function(){
                    for(var i=0;i<snackBody.length-1;i++){
                        snackBody[i].left=snackBody[i+1].left;
                        snackBody[i].top=snackBody[i+1].top;
                    }
                    switch (dir){
                        case 'left':
                            snackBody[snackBody.length-1].left--;
                            break;
                        case 'right':
                            snackBody[snackBody.length-1].left++;
                            break;
                        case 'top':
                            snackBody[snackBody.length-1].top--;
                            break;
                        case 'bottom':
                            snackBody[snackBody.length-1].top++;
                            break;
                    }

                    var aSnack=snackBody[snackBody.length-1];
                    if((arrFood[0]==aSnack.left)&&(arrFood[1]==aSnack.top)){
                        oScore.innerHTML++;
                        if(oScore.innerHTML>=3){
                            speed=180;
                        }else if(oScore.innerHTML>=6){
                            speed=160;
                        }else if(oScore.innerHTML>=9){
                            speed=140;
                        }else if(oScore.innerHTML>=12){
                            speed=120;
                        }else if(oScore.innerHTML>=15){
                            speed=100
                        }else if(oScore.innerHTML>=18){
                            speed=80;
                        }
                        var json={left:snackBody[0].left,top:snackBody[0].top,background:snackBody[0].background,obj:null};
                        snackBody.unshift(json);
                        //console.log(json);
                        createFood();
                    }
                    if(aSnack.left<0||aSnack.top<0||aSnack.left>oX-1||aSnack.top>oY-1){
                        alert('game over!');
                        clearInterval(timer);
                        return;
                    }
                    for(var i=0;i<snackBody.length-1;i++){
                        if((aSnack.left==snackBody[i].left)&&(aSnack.top==snackBody[i].top)){
                            alert('吃到自己了,game over!');
                            clearInterval(timer);
                            return;
                        }
                    }
                    createSnack();
                },speed);
            }


            document.onkeydown=function(ev){
                var oEvent=ev||event;

                switch (oEvent.keyCode){
                    case 37:
                        dir='left';
                        break;
                    case 38:
                        dir='top';
                        break;
                    case 39:
                        dir='right';
                        break;
                    case 40:
                        dir='bottom';
                        break;
                    case 32:
                        pause();
                        break;
                }
            };
        });
    </script>
</head>
<body>
    <div id="box">
        <input id="open" type="button" value="开始游戏"/>
        <input id="pause" type="button" value="暂停（space键）"/>
        <input id="accelerate" type="button" value="加速"/>
        <input id="restart" type="button" value="重新开始"/>
        <span>当前积分：<strong class="score">0</strong></span>
        <div id="main"></div>
    </div>
</body>
</html>